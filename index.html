<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fuel Pricing Calculator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --dark-bg: #0a0f1c;
      --card-bg: #121827;
      --accent-blue: #1a3a5f;
      --accent-light: #2a4d7a;
      --text-primary: #e0e0e0;
      --text-secondary: #a0aec0;
      --success: #2d9d78;
    }
    * {margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
    body {background:var(--dark-bg);color:var(--text-primary);padding:20px;min-height:100vh;}
    .container {max-width: 1300px;margin:auto;}
    header {text-align:center;margin-bottom:30px;background:var(--card-bg);padding:20px;border-radius:6px;}
    h1 {font-size:2.2rem;margin-bottom:10px;}
    .subtitle {color:var(--text-secondary);}
    .calculator-container {display:grid;grid-template-columns:1fr 1fr;gap:25px;margin-bottom:30px;}
    .details-container {display:grid;grid-template-columns:1fr 1fr 1fr;gap:25px;margin-bottom:30px;}
    @media(max-width:1200px){.details-container{grid-template-columns:1fr 1fr;}}
    @media(max-width:900px){.calculator-container{grid-template-columns:1fr;}.details-container{grid-template-columns:1fr;}}
    .card {background:var(--card-bg);padding:25px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.4);}
    h2 {margin-bottom:15px;font-size:1.4rem;color:var(--accent-light);}
    .input-group{margin-bottom:20px;}
    label {display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;font-size:0.95rem;}
    select,input[type=range]{width:100%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:var(--text-primary);font-size:1rem;transition:border-color 0.3s ease;}
    select:focus,input[type=range]:focus{outline:none;border-color:var(--accent-light);box-shadow:0 0 0 2px rgba(42,77,122,0.3);}
    .range-container{display:flex;align-items:center;gap:15px;}
    .range-value{background:linear-gradient(135deg,var(--accent-blue),var(--accent-light));padding:8px 14px;border-radius:20px;color:white;font-weight:600;min-width:50px;text-align:center;}
    .btn-calc{margin-top:25px;width:100%;padding:14px;background:linear-gradient(135deg,var(--accent-blue),var(--accent-light));border:none;color:white;border-radius:8px;font-weight:600;font-size:1.05rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(26,58,95,0.3);}
    .btn-calc:hover{opacity:0.9;transform:translateY(-2px);box-shadow:0 6px 20px rgba(26,58,95,0.4);}
    .final-price{text-align:center;font-size:2.5rem;font-weight:700;color:var(--success);margin:20px 0;padding:15px;background:rgba(45,157,120,0.1);border-radius:8px;border:2px solid rgba(45,157,120,0.3);}
    .results{margin-top:20px;border-top:2px solid rgba(255,255,255,0.1);padding-top:20px;}
    .price-item{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.08);font-size:1.05rem;}
    .price-item:last-child{border:none;}
    .price-item span:first-child{color:var(--text-secondary);font-weight:500;}
    .price-item span:last-child{color:var(--text-primary);font-weight:600;}
    .chart-container{margin-top:25px;padding:20px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.05);}
    .chart-title{font-size:1.1rem;color:var(--accent-light);margin-bottom:15px;font-weight:600;text-align:center;}
    canvas{margin-top:20px !important;}
    .collapsible-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);}
    .collapsible-header:hover{background:rgba(255,255,255,0.05);border-radius:6px;padding:10px;}
    .collapsible-header h2{margin:0;}
    .collapsible-content{max-height:0;overflow:hidden;transition:max-height 0.3s ease;padding:0 10px;}
    .collapsible-content.expanded{max-height:800px;padding:15px 10px;}
    .param-row{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;}
    .param-buttons{display:flex;gap:10px;margin-top:20px;justify-content:center;}
    .btn-param{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-weight:600;}
    .btn-apply{background:#2d9d78;color:white;} .btn-apply:hover{background:#26885f;}
    .btn-reset{background:#dc3545;color:white;} .btn-reset:hover{background:#c82333;}
    .btn-hide{background:#6c757d;color:white;} .btn-hide:hover{background:#5a6268;}
    .status-banner{background:#2d9d78;color:white;padding:10px;border-radius:4px;margin:10px 0;text-align:center;display:none;}
    .reminder-banner{background:#007bff;color:white;padding:10px;border-radius:4px;margin:10px 0;text-align:center;display:none;}
    .input-group{margin-bottom:15px;}
    h3{color:var(--accent-light);font-size:1.1rem;margin-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:5px;}
    .section-title{font-size:1rem;color:var(--accent-light);margin-bottom:12px;font-weight:600;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:6px;}
    .detail-item{display:flex;justify-content:space-between;padding:8px 0;font-size:0.95rem;}
    .detail-item span:first-child{color:var(--text-secondary);}
    .detail-item span:last-child{color:var(--text-primary);font-weight:600;}
    .highlight-value{color:var(--success) !important;font-weight:700 !important;}
    .risk-value{color:#ffc107 !important;font-weight:700 !important;}
    .discount-value{color:#dc3545 !important;font-weight:700 !important;}
    .param-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:15px;min-height:120px;}
    .param-card h4{color:var(--accent-light);margin:0 0 12px 0;font-size:14px;font-weight:600;text-align:center;}
    .compact-input{margin-bottom:10px;}
    .compact-input label{font-size:12px;color:var(--text-muted);margin-bottom:4px;display:block;}
    .btn-param{background:linear-gradient(135deg,var(--accent-blue),var(--accent-light));color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.3s ease;box-shadow:0 2px 6px rgba(26,58,95,0.2);height:32px;display:flex;align-items:center;justify-content:center;min-width:60px;}
    .btn-param:hover{opacity:0.9;transform:translateY(-1px);box-shadow:0 3px 10px rgba(26,58,95,0.3);}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-gas-pump" style="margin-right: 10px; color: #2d9d78;"></i>Fuel Pricing Calculator</h1>
      <p class="subtitle">Wholesale & Retail Dynamic Pricing with Visual Analytics</p>
    </header>

    <div class="card" style="margin-bottom: 25px;">
      <div class="collapsible-header" onclick="toggleParameters()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 5px 0;">
        <h2 style="margin: 0;"><i class="fas fa-sliders-h"></i> Parameters</h2>
        <i class="fas fa-chevron-down" id="paramToggle" style="transition: transform 0.3s ease; color: var(--accent-light);"></i>
      </div>
      <div id="parametersSummary" style="display: none; color: var(--text-secondary); margin: 10px 0; font-size: 0.85em;">
        <span id="summaryText">Base R19.80/L • Wholesale 6.2% • Retail 7.8%</span>
      </div>
      
      <div id="parametersContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; overflow: hidden; transition: all 0.3s ease;">
        <div class="param-card">
          <h4>Base & Levies</h4>
          <div class="compact-input">
            <label>Base Cost</label>
            <div class="range-container">
              <input type="range" id="baseCostSlider" min="10" max="30" step="0.1" value="19.8">
              <span class="range-value" id="baseCostValue">R19.80</span>
            </div>
          </div>
          <div class="compact-input">
            <label>Fuel Levy</label>
            <div class="range-container">
              <input type="range" id="fuelLevySlider" min="1" max="6" step="0.1" value="2.5">
              <span class="range-value" id="fuelLevyValue">R2.50</span>
            </div>
          </div>
        </div>

        <div class="param-card">
          <h4>Margins</h4>
          <div class="compact-input">
            <label>Wholesale</label>
            <div class="range-container">
              <input type="range" id="wholesaleMarginSlider" min="2" max="12" step="0.1" value="6.2">
              <span class="range-value" id="wholesaleMarginValue">6.2%</span>
            </div>
          </div>
          <div class="compact-input">
            <label>Retail</label>
            <div class="range-container">
              <input type="range" id="retailMarginSlider" min="3" max="15" step="0.1" value="7.8">
              <span class="range-value" id="retailMarginValue">7.8%</span>
            </div>
          </div>
        </div>

        <div class="param-card">
          <h4>Risk</h4>
          <div class="compact-input">
            <label>Currency</label>
            <div class="range-container">
              <input type="range" id="currencyRiskSlider" min="0.5" max="5" step="0.1" value="2.8">
              <span class="range-value" id="currencyRiskValue">2.8%</span>
            </div>
          </div>
          <div class="compact-input">
            <label>Political</label>
            <div class="range-container">
              <input type="range" id="politicalRiskSlider" min="0.5" max="4" step="0.1" value="2.2">
              <span class="range-value" id="politicalRiskValue">2.2%</span>
            </div>
          </div>
        </div>

        <div class="param-card">
          <h4>Other</h4>
          <div class="compact-input">
            <label>Transport</label>
            <div class="range-container">
              <input type="range" id="transportSlider" min="0.2" max="1.5" step="0.05" value="0.65">
              <span class="range-value" id="transportValue">R0.65</span>
            </div>
          </div>
          <div class="compact-input">
            <label>Max Discount</label>
            <div class="range-container">
              <input type="range" id="maxDiscountSlider" min="3" max="12" step="0.1" value="6.5">
              <span class="range-value" id="maxDiscountValue">6.5%</span>
            </div>
          </div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 15px; display: flex; gap: 8px; justify-content: center;">
        <button class="btn-param" id="applyParams">
          Apply
        </button>
        <button class="btn-param" id="resetParams" style="background: #dc3545;">
          Reset
        </button>
        <button class="btn-param" onclick="toggleParameters()" style="background: #6c757d;">
          Hide
        </button>
      </div>
    </div>

    <div class="calculator-container">
      <div class="card">
        <h2>Scenario Calculator</h2>
        <div id="parameterStatus" style="display: none; background: rgba(45, 157, 120, 0.1); border: 1px solid rgba(45, 157, 120, 0.3); border-radius: 4px; padding: 8px; margin-bottom: 15px; font-size: 0.9em; color: #2d9d78;">
          <i class="fas fa-check-circle"></i> Using custom parameters globally
        </div>
        <div class="input-group">
          <label>Customer Price Tier (1–14)</label>
          <div class="range-container">
            <input type="range" id="tier" min="1" max="14" value="6">
            <span class="range-value" id="tierValue">6</span>
          </div>
        </div>
        <div class="input-group">
          <label>Country</label>
          <select id="country">
            <option value="south-africa">South Africa</option>
            <option value="zimbabwe" selected>Zimbabwe</option>
            <option value="botswana">Botswana</option>
          </select>
        </div>
        <div class="input-group">
          <label>Grid Location</label>
          <select id="grid">
            <option value="coastal">Coastal</option>
            <option value="inland" selected>Inland</option>
          </select>
        </div>
        <button class="btn-calc" id="calcBtn"><i class="fas fa-calculator"></i> Calculate Scenario</button>
        <div id="calculateReminder" style="display: none; text-align: center; margin-top: 10px; font-size: 0.85em; color: var(--text-secondary);">
          <i class="fas fa-info-circle"></i> Click Calculate to apply current settings
        </div>
      </div>

      <div class="card">
        <h2>Price Results</h2>
        <div class="final-price" id="finalPrice">R0.00/L</div>
        <div class="results">
          <div class="price-item"><span>Wholesale Price</span><span id="wholesale">R0.00</span></div>
          <div class="price-item"><span>Retail Margin</span><span id="margin">R0.00</span></div>
          <div class="price-item"><span>Base Retail</span><span id="baseRetail">R0.00</span></div>
          <div class="price-item"><span>Tier Discount</span><span id="discount">-R0.00</span></div>
          <div class="price-item"><span>Transport Cost</span><span id="transport">+R0.00</span></div>
          <div class="price-item"><span>Currency Risk</span><span id="currency">+R0.00</span></div>
        </div>
      </div>
    </div>

    <div class="details-container">
      <div class="card">
        <h2>Wholesale Calculations</h2>
        <div class="section-title">Dynamic Wholesale Price</div>
        <div class="detail-item"><span>Base Wholesale Rate:</span><span id="baseWholesaleRate">R0.00</span></div>
        <div class="detail-item"><span>Dynamic Wholesale Price:</span><span id="dynamicWholesale" class="highlight-value">R0.00</span></div>
        
        <div class="section-title">Margin Calculations</div>
        <div class="detail-item"><span>Calculated Margin %:</span><span id="marginPercent">0.0%</span></div>
        <div class="detail-item"><span>Calculated Margin Amount:</span><span id="calculatedMargin" class="highlight-value">R0.00</span></div>
        <div class="detail-item"><span>Base Retail Price:</span><span id="baseRetailPrice" class="highlight-value">R0.00</span></div>
      </div>

      <div class="card">
        <h2>Volume & Loyalty</h2>
        <div class="section-title">Volume Estimation</div>
        <div class="detail-item"><span>Estimated Volume:</span><span id="estimatedVolume">0 liters</span></div>
        <div class="detail-item"><span>Volume Multiplier:</span><span id="volumeMultiplier">1.0x</span></div>
        
        <div class="section-title">Tier Adjustments</div>
        <div class="detail-item"><span>Tier Level:</span><span id="tierLevel">Tier 6</span></div>
        <div class="detail-item"><span>Dynamic Discount %:</span><span id="dynamicDiscountPercent">14.6%</span></div>
        <div class="detail-item"><span>Tier Discount Amount:</span><span id="tierDiscountAmount" class="discount-value">-R0.00</span></div>
      </div>

      <div class="card">
        <h2>Transportation & Risk</h2>
        <div class="section-title">Transport Costs</div>
        <div class="detail-item"><span>Grid Location:</span><span id="gridLocation">Inland</span></div>
        <div class="detail-item"><span>Transport Cost:</span><span id="transportCostDetail">+R0.00</span></div>
        
        <div class="section-title">Risk Premiums</div>
        <div class="detail-item"><span>Political Risk:</span><span id="politicalRisk" class="risk-value">+0.0%</span></div>
        <div class="detail-item"><span>Currency Risk Premium:</span><span id="currencyRiskPremium" class="risk-value">+R0.00</span></div>
        <div class="detail-item"><span>Live Exchange Rate:</span><span id="liveExchangeRate">0.00</span></div>
      </div>
    </div>

    <div class="card">
      <h2><i class="fas fa-chart-line"></i> Advanced Analytics Dashboard</h2>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div style="position: relative; height: 300px;">
          <canvas id="lineChart"></canvas>
        </div>
        <div style="position: relative; height: 300px;">
          <canvas id="barChart"></canvas>
        </div>
      </div>
      <div style="position: relative; height: 250px; margin-top: 20px;">
        <canvas id="comparisonChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // REALISTIC FUEL PRICING MODEL - Corrected to match actual market prices
    const model = {
      // REALISTIC base fuel costs per liter (matching current market prices)
      baseFuelCost: {
        'south-africa': 16.50,  // ~R16.50/L (current SA petrol price range)
        'zimbabwe': 19.80,      // ~R19.80/L (higher due to supply issues)
        'botswana': 17.20       // ~R17.20/L (moderate pricing)
      },
      
      // SMALL wholesale margins (realistic percentages)
      wholesaleMarginPct: {
        'south-africa': 0.048,  // 4.8% wholesale margin
        'zimbabwe': 0.062,      // 6.2% higher margin due to risk
        'botswana': 0.055       // 5.5% moderate margin
      },
      
      // SMALL retail margins (realistic percentages)
      retailMarginPct: {
        'south-africa': 0.065,  // 6.5% retail margin
        'zimbabwe': 0.078,      // 7.8% higher retail margin
        'botswana': 0.070       // 7.0% moderate retail margin
      },
      
      // Government fuel levy (FIXED amounts per liter - realistic)
      fuelLevy: {
        'south-africa': 3.93,   // Current SA fuel levy R3.93/L
        'zimbabwe': 2.50,       // Lower absolute levy
        'botswana': 2.20        // Moderate levy
      },
      
      // SMALLER tier discounts (reasonable loyalty discounts)
      tierDiscounts: {
        1:0.00, 2:0.005, 3:0.010, 4:0.015, 5:0.020, 6:0.025,
        7:0.030, 8:0.035, 9:0.040, 10:0.045, 11:0.050, 12:0.055,
        13:0.060, 14:0.065
      },
      
      // REALISTIC transport costs per liter with significant inland/coastal differences
      transportCost: {
        'south-africa': {
          'coastal': 0.85,      // R0.85/L coastal transport
          'inland': 3.28        // R3.28/L inland transport (R2.43 difference)
        },
        'zimbabwe': {
          'coastal': 1.15,      // R1.15/L coastal transport  
          'inland': 2.72        // R2.72/L inland transport (R1.57 difference)
        },
        'botswana': {
          'coastal': 0.95,      // R0.95/L coastal transport
          'inland': 2.84        // R2.84/L inland transport (R1.89 difference)
        }
      },
      
      // SMALL risk premiums (realistic percentages)
      currencyRisk: {
        'south-africa': 0.012,  // 1.2% currency risk
        'zimbabwe': 0.028,      // 2.8% currency risk
        'botswana': 0.015       // 1.5% moderate risk
      },
      
      politicalRisk: {
        'south-africa': 0.008,  // 0.8% political risk
        'zimbabwe': 0.022,      // 2.2% political risk
        'botswana': 0.010       // 1.0% stable environment
      },
      
      // Realistic institutional volumes
      volumeEstimates: {
        1: 2500, 2: 3200, 3: 4000, 4: 4800, 5: 5600, 6: 6500,
        7: 7200, 8: 8000, 9: 8800, 10: 9600, 11: 10400, 12: 11200,
        13: 12000, 14: 12800
      }
    };

    // DOM elements
    const tier=document.getElementById("tier"), tierValue=document.getElementById("tierValue"),
          country=document.getElementById("country"), grid=document.getElementById("grid"),
          finalPrice=document.getElementById("finalPrice"), wholesale=document.getElementById("wholesale"),
          margin=document.getElementById("margin"), baseRetail=document.getElementById("baseRetail"),
          discount=document.getElementById("discount"), transport=document.getElementById("transport"),
          currency=document.getElementById("currency"), btn=document.getElementById("calcBtn");

    // Configurable parameter sliders
    const baseCostSlider = document.getElementById("baseCostSlider");
    const fuelLevySlider = document.getElementById("fuelLevySlider");
    const wholesaleMarginSlider = document.getElementById("wholesaleMarginSlider");
    const retailMarginSlider = document.getElementById("retailMarginSlider");
    const currencyRiskSlider = document.getElementById("currencyRiskSlider");
    const politicalRiskSlider = document.getElementById("politicalRiskSlider");
    const transportSlider = document.getElementById("transportSlider");
    const maxDiscountSlider = document.getElementById("maxDiscountSlider");

    let lineChart, barChart, comparisonChart;

    // Track if user has applied custom parameters
    let userParametersApplied = false;

    // Event listeners for sliders with real-time updates
    tier.addEventListener("input", () => { tierValue.textContent = tier.value; });
    country.addEventListener("change", () => { 
      if (!userParametersApplied) {
        loadCountryDefaults(); 
      } else {
        // Show reminder to recalculate with new selection
        document.getElementById('calculateReminder').style.display = 'block';
      }
    });
    grid.addEventListener("change", () => { 
      if (!userParametersApplied) {
        loadLocationDefaults(); 
      } else {
        // Show reminder to recalculate with new selection
        document.getElementById('calculateReminder').style.display = 'block';
      }
    });
    
    // Slider event listeners - only update display values, not calculations
    baseCostSlider.addEventListener("input", () => { 
      document.getElementById("baseCostValue").textContent = `R${parseFloat(baseCostSlider.value).toFixed(2)}`; 
    });
    fuelLevySlider.addEventListener("input", () => { 
      document.getElementById("fuelLevyValue").textContent = `R${parseFloat(fuelLevySlider.value).toFixed(2)}`; 
    });
    wholesaleMarginSlider.addEventListener("input", () => { 
      document.getElementById("wholesaleMarginValue").textContent = `${parseFloat(wholesaleMarginSlider.value).toFixed(1)}%`; 
    });
    retailMarginSlider.addEventListener("input", () => { 
      document.getElementById("retailMarginValue").textContent = `${parseFloat(retailMarginSlider.value).toFixed(1)}%`; 
    });
    currencyRiskSlider.addEventListener("input", () => { 
      document.getElementById("currencyRiskValue").textContent = `${parseFloat(currencyRiskSlider.value).toFixed(1)}%`; 
    });
    politicalRiskSlider.addEventListener("input", () => { 
      document.getElementById("politicalRiskValue").textContent = `${parseFloat(politicalRiskSlider.value).toFixed(1)}%`; 
    });
    transportSlider.addEventListener("input", () => { 
      document.getElementById("transportValue").textContent = `R${parseFloat(transportSlider.value).toFixed(2)}`; 
    });
    maxDiscountSlider.addEventListener("input", () => { 
      document.getElementById("maxDiscountValue").textContent = `${parseFloat(maxDiscountSlider.value).toFixed(1)}%`; 
    });

    // Button event listeners
    btn.addEventListener("click", () => { calculate(); });
    
    document.getElementById("resetParams").addEventListener("click", () => {
      resetToDefaults();
    });
    
    document.getElementById("applyParams").addEventListener("click", () => {
      // Apply current slider values as BASE values, but maintain country/location differences
      const baseValues = {
        baseCost: parseFloat(baseCostSlider.value),
        fuelLevy: parseFloat(fuelLevySlider.value),  
        wholesaleMargin: parseFloat(wholesaleMarginSlider.value) / 100,
        retailMargin: parseFloat(retailMarginSlider.value) / 100,
        currencyRisk: parseFloat(currencyRiskSlider.value) / 100,
        politicalRisk: parseFloat(politicalRiskSlider.value) / 100,
        transportCost: parseFloat(transportSlider.value)
      };
      
      // Apply base values with country-specific multipliers to maintain differences
      const countryMultipliers = {
        'south-africa': { base: 0.83, levy: 1.57, wholesale: 0.77, retail: 0.83, currency: 0.43, political: 0.36 },
        'zimbabwe': { base: 1.00, levy: 1.00, wholesale: 1.00, retail: 1.00, currency: 1.00, political: 1.00 }, // Zimbabwe as base (current country)
        'botswana': { base: 0.87, levy: 0.88, wholesale: 0.89, retail: 0.90, currency: 0.54, political: 0.45 }
      };
      
      // Apply adjusted values to each country to maintain realistic differences
      Object.keys(countryMultipliers).forEach(c => {
        const mult = countryMultipliers[c];
        model.baseFuelCost[c] = baseValues.baseCost * mult.base;
        model.fuelLevy[c] = baseValues.fuelLevy * mult.levy;  
        model.wholesaleMarginPct[c] = baseValues.wholesaleMargin * mult.wholesale;
        model.retailMarginPct[c] = baseValues.retailMargin * mult.retail;
        model.currencyRisk[c] = baseValues.currencyRisk * mult.currency;
        model.politicalRisk[c] = baseValues.politicalRisk * mult.political;
      });
      
      // Apply transport costs with country and location specific differences  
      Object.keys(countryMultipliers).forEach(c => {
        const mult = countryMultipliers[c];
        // Maintain the realistic differences: SA R2.43, ZW R1.57, BW R1.89
        const coastalBase = baseValues.transportCost * mult.base * 0.6; // Coastal base
        const inlandDiff = c === 'south-africa' ? 2.43 : c === 'zimbabwe' ? 1.57 : 1.89;
        model.transportCost[c] = {
          'coastal': coastalBase,
          'inland': coastalBase + inlandDiff
        };
      });
      
      // Update tier discounts based on max discount slider
      const maxDisc = parseFloat(maxDiscountSlider.value) / 100;
      for (let i = 1; i <= 14; i++) {
        model.tierDiscounts[i] = (maxDisc / 14) * i;
      }
      
      // Mark that user has applied custom parameters
      userParametersApplied = true;
      
      // Show parameter status indicator
      document.getElementById('parameterStatus').style.display = 'block';
      
      // Update parameter summary
      updateParametersSummary();
      
      // Don't automatically calculate - wait for user to click Calculate button
      // Show a visual indicator that parameters have been applied
      const applyBtn = document.getElementById("applyParams");
      const originalText = applyBtn.textContent;
      applyBtn.textContent = "Applied ✓";
      applyBtn.style.background = "#28a745";
      setTimeout(() => {
        applyBtn.textContent = originalText;
        applyBtn.style.background = "";
      }, 1500);
    });

    // Load country-specific defaults when country changes
    function loadCountryDefaults() {
      // Don't change slider values if user has applied custom parameters
      if (userParametersApplied) {
        return;
      }
      
      const c = country.value;
      const defaults = {
        'south-africa': { base: 16.5, levy: 3.93, wholesale: 4.8, retail: 6.5, currency: 1.2, political: 0.8 },
        'zimbabwe': { base: 19.8, levy: 2.5, wholesale: 6.2, retail: 7.8, currency: 2.8, political: 2.2 },
        'botswana': { base: 17.2, levy: 2.2, wholesale: 5.5, retail: 7.0, currency: 1.5, political: 1.0 }
      };
      
      const def = defaults[c];
      baseCostSlider.value = def.base;
      fuelLevySlider.value = def.levy;
      wholesaleMarginSlider.value = def.wholesale;
      retailMarginSlider.value = def.retail;
      currencyRiskSlider.value = def.currency;
      politicalRiskSlider.value = def.political;
      
      // Update displays
      document.getElementById("baseCostValue").textContent = `R${def.base.toFixed(2)}`;
      document.getElementById("fuelLevyValue").textContent = `R${def.levy.toFixed(2)}`;
      document.getElementById("wholesaleMarginValue").textContent = `${def.wholesale.toFixed(1)}%`;
      document.getElementById("retailMarginValue").textContent = `${def.retail.toFixed(1)}%`;
      document.getElementById("currencyRiskValue").textContent = `${def.currency.toFixed(1)}%`;
      document.getElementById("politicalRiskValue").textContent = `${def.political.toFixed(1)}%`;
    }

    // Load location-specific defaults when location changes  
    function loadLocationDefaults() {
      // Don't change slider values if user has applied custom parameters
      if (userParametersApplied) {
        return;
      }
      
      const c = country.value;
      const g = grid.value;
      const transportCost = model.transportCost[c][g];
      transportSlider.value = transportCost;
      document.getElementById("transportValue").textContent = `R${transportCost.toFixed(2)}`;
    }

    // Update model with current slider values
    function updateModelAndCalculate() {
      const currentCountry = country.value;
      const currentGrid = grid.value;
      
      // Update model with slider values (formula-driven!)
      model.baseFuelCost[currentCountry] = parseFloat(baseCostSlider.value);
      model.fuelLevy[currentCountry] = parseFloat(fuelLevySlider.value);
      model.wholesaleMarginPct[currentCountry] = parseFloat(wholesaleMarginSlider.value) / 100;
      model.retailMarginPct[currentCountry] = parseFloat(retailMarginSlider.value) / 100;
      model.currencyRisk[currentCountry] = parseFloat(currencyRiskSlider.value) / 100;
      model.politicalRisk[currentCountry] = parseFloat(politicalRiskSlider.value) / 100;
      // Transport cost is now country-specific, so update the nested structure
      model.transportCost[currentCountry][currentGrid] = parseFloat(transportSlider.value);
      
      calculate();
    }

    // Update tier discount structure
    function updateTierDiscounts() {
      const maxDiscountPct = parseFloat(maxDiscountSlider.value) / 100;
      for (let i = 1; i <= 14; i++) {
        model.tierDiscounts[i] = (maxDiscountPct / 14) * i;
      }
    }

    // Reset parameters to defaults
    function resetToDefaults() {
      // Reset all sliders to default values
      const c = country.value;
      const g = grid.value;
      
      // Reset model to original defaults
      model.baseFuelCost = {
        'south-africa': 16.50, 'zimbabwe': 19.80, 'botswana': 17.20
      };
      model.fuelLevy = {
        'south-africa': 3.93, 'zimbabwe': 2.50, 'botswana': 2.20
      };
      model.wholesaleMarginPct = {
        'south-africa': 0.048, 'zimbabwe': 0.062, 'botswana': 0.055
      };
      model.retailMarginPct = {
        'south-africa': 0.065, 'zimbabwe': 0.078, 'botswana': 0.070
      };
      model.currencyRisk = {
        'south-africa': 0.012, 'zimbabwe': 0.028, 'botswana': 0.015
      };
      model.politicalRisk = {
        'south-africa': 0.008, 'zimbabwe': 0.022, 'botswana': 0.010
      };
      model.transportCost = {
        'south-africa': {
          'coastal': 0.85,      // R0.85/L coastal transport
          'inland': 3.28        // R3.28/L inland transport (R2.43 difference)
        },
        'zimbabwe': {
          'coastal': 1.15,      // R1.15/L coastal transport  
          'inland': 2.72        // R2.72/L inland transport (R1.57 difference)
        },
        'botswana': {
          'coastal': 0.95,      // R0.95/L coastal transport
          'inland': 2.84        // R2.84/L inland transport (R1.89 difference)
        }
      };
      model.tierDiscounts = {
        1:0.00, 2:0.005, 3:0.010, 4:0.015, 5:0.020, 6:0.025,
        7:0.030, 8:0.035, 9:0.040, 10:0.045, 11:0.050, 12:0.055,
        13:0.060, 14:0.065
      };
      
      // Clear the user parameters flag to allow defaults to load
      userParametersApplied = false;
      
      // Hide parameter status indicator
      document.getElementById('parameterStatus').style.display = 'none';
      
      // Reset slider positions and display values
      loadCountryDefaults();
      loadLocationDefaults();
      maxDiscountSlider.value = "6.5";
      document.getElementById("maxDiscountValue").textContent = "6.5%";
      
      // Update parameter summary but don't auto-calculate
      updateParametersSummary();
      
      // Show visual feedback that reset was applied
      const resetBtn = document.getElementById("resetParams");
      const originalText = resetBtn.textContent;
      resetBtn.textContent = "Reset ✓";
      setTimeout(() => {
        resetBtn.textContent = originalText;
      }, 1500);
    }

    function calculateFuelPrice(tierLevel, country, gridLocation) {
      // CORRECTED CALCULATION - Realistic per-liter pricing
      
      // STEP 1: Start with realistic base fuel cost (includes crude, refining, basic costs)
      const baseCostPerLiter = model.baseFuelCost[country];
      
      // STEP 2: Add government fuel levy (FIXED amount per liter)
      const fuelLevyPerLiter = model.fuelLevy[country];
      const costAfterLevyPerLiter = baseCostPerLiter + fuelLevyPerLiter;
      
      // STEP 3: Calculate wholesale price (SMALL percentage margin)
      const wholesaleMarginPct = model.wholesaleMarginPct[country];
      const wholesaleMarginPerLiter = costAfterLevyPerLiter * wholesaleMarginPct;
      const wholesalePricePerLiter = costAfterLevyPerLiter + wholesaleMarginPerLiter;
      
      // STEP 4: Calculate retail margin (SMALL percentage of wholesale)
      const retailMarginPct = model.retailMarginPct[country];
      const retailMarginPerLiter = wholesalePricePerLiter * retailMarginPct;
      const baseRetailPricePerLiter = wholesalePricePerLiter + retailMarginPerLiter;
      
      // STEP 5: Apply tier discount (SMALL percentage of base retail)
      const tierDiscountPct = model.tierDiscounts[tierLevel];
      const tierDiscountPerLiter = baseRetailPricePerLiter * tierDiscountPct;
      const priceAfterDiscountPerLiter = baseRetailPricePerLiter - tierDiscountPerLiter;
      
      // STEP 6: Add transport cost (COUNTRY and LOCATION specific amounts per liter)
      const transportCostPerLiter = model.transportCost[country][gridLocation];
      const priceAfterTransportPerLiter = priceAfterDiscountPerLiter + transportCostPerLiter;
      
      // STEP 7: Apply SMALL risk premiums (small percentages)
      const currencyRiskPct = model.currencyRisk[country];
      const politicalRiskPct = model.politicalRisk[country];
      
      const currencyRiskPerLiter = priceAfterTransportPerLiter * currencyRiskPct;
      const politicalRiskPerLiter = priceAfterTransportPerLiter * politicalRiskPct;
      
      // STEP 8: Calculate REALISTIC final retail price per liter
      const finalRetailPricePerLiter = priceAfterTransportPerLiter + currencyRiskPerLiter + politicalRiskPerLiter;
      
      // STEP 9: Calculate total cost for estimated volume
      const estimatedVolume = model.volumeEstimates[tierLevel];
      const totalCost = finalRetailPricePerLiter * estimatedVolume;
      
      return {
        // Realistic per-liter breakdown
        baseCostPerLiter: baseCostPerLiter,
        fuelLevyPerLiter: fuelLevyPerLiter,
        wholesalePricePerLiter: wholesalePricePerLiter,
        retailMarginPerLiter: retailMarginPerLiter,
        baseRetailPricePerLiter: baseRetailPricePerLiter,
        tierDiscountPerLiter: tierDiscountPerLiter,
        priceAfterDiscountPerLiter: priceAfterDiscountPerLiter,  // Added for charts
        transportCostPerLiter: transportCostPerLiter,
        priceAfterTransportPerLiter: priceAfterTransportPerLiter,  // Added for charts
        currencyRiskPerLiter: currencyRiskPerLiter,
        politicalRiskPerLiter: politicalRiskPerLiter,
        finalRetailPricePerLiter: finalRetailPricePerLiter,
        
        // Volume calculations
        estimatedVolume: estimatedVolume,
        totalCost: totalCost,
        
        // Percentages for display (corrected)
        wholesaleMarginPct: wholesaleMarginPct,
        retailMarginPct: retailMarginPct,
        tierDiscountPct: tierDiscountPct,
        currencyRiskPct: currencyRiskPct,
        politicalRiskPct: politicalRiskPct
      };
    }

    function calculate(){
      // Hide the calculate reminder
      document.getElementById('calculateReminder').style.display = 'none';
      
      const t = parseInt(tier.value);
      const c = country.value;
      const g = grid.value;
      
      const result = calculateFuelPrice(t, c, g);
      
      // Update main price display with REALISTIC price
      finalPrice.textContent = `R${result.finalRetailPricePerLiter.toFixed(2)}/L`;
      
      // Update summary breakdown with corrected values and percentages
      wholesale.textContent = `R${result.wholesalePricePerLiter.toFixed(2)} (${(result.wholesaleMarginPct*100).toFixed(1)}%)`;
      margin.textContent = `R${result.retailMarginPerLiter.toFixed(2)} (${(result.retailMarginPct*100).toFixed(1)}%)`;
      baseRetail.textContent = `R${result.baseRetailPricePerLiter.toFixed(2)}`;
      discount.textContent = `-R${result.tierDiscountPerLiter.toFixed(2)} (${(result.tierDiscountPct*100).toFixed(1)}%)`;
      transport.textContent = `+R${result.transportCostPerLiter.toFixed(2)}`;
      currency.textContent = `+R${result.currencyRiskPerLiter.toFixed(2)} (${(result.currencyRiskPct*100).toFixed(1)}%)`;
      
      // Update detailed breakdown sections with realistic values
      try {
        document.getElementById('baseWholesaleRate').textContent = `R${result.baseCostPerLiter.toFixed(2)} (Base Cost)`;
        document.getElementById('dynamicWholesale').textContent = `R${result.wholesalePricePerLiter.toFixed(2)} (${(result.wholesaleMarginPct*100).toFixed(1)}% margin)`;
        document.getElementById('marginPercent').textContent = `${(result.retailMarginPct*100).toFixed(1)}% (Dynamic)`;
        document.getElementById('calculatedMargin').textContent = `R${result.retailMarginPerLiter.toFixed(2)}`;
        document.getElementById('baseRetailPrice').textContent = `R${result.baseRetailPricePerLiter.toFixed(2)}`;
        
        document.getElementById('estimatedVolume').textContent = `${result.estimatedVolume.toLocaleString()} liters`;
        document.getElementById('volumeMultiplier').textContent = `${(result.estimatedVolume / 5000).toFixed(1)}x`;
        document.getElementById('tierLevel').textContent = `Tier ${t}`;
        document.getElementById('dynamicDiscountPercent').textContent = `${(result.tierDiscountPct * 100).toFixed(1)}% (Loyalty)`;
        document.getElementById('tierDiscountAmount').textContent = `-R${result.tierDiscountPerLiter.toFixed(2)}`;
        
        document.getElementById('gridLocation').textContent = g.charAt(0).toUpperCase() + g.slice(1);
        document.getElementById('transportCostDetail').textContent = `+R${result.transportCostPerLiter.toFixed(2)}`;
        document.getElementById('politicalRisk').textContent = `+${(result.politicalRiskPct * 100).toFixed(1)}% (Country Risk)`;
        document.getElementById('currencyRiskPremium').textContent = `+R${result.currencyRiskPerLiter.toFixed(2)} (${(result.currencyRiskPct*100).toFixed(1)}%)`;
        document.getElementById('liveExchangeRate').textContent = `${c === 'zimbabwe' ? 'ZWL' : c === 'botswana' ? 'BWP' : 'ZAR'} Currency`;
      } catch(e) {
        console.log('Some detail elements not found, but main calculation works');
      }
      
      // Console log for debugging - realistic pricing confirmed
      console.log(`CORRECTED PRICING: ${c.toUpperCase()} Tier ${t} ${g} = R${result.finalRetailPricePerLiter.toFixed(2)}/L`);
      console.log('Total Cost:', `R${result.totalCost.toFixed(2)} for ${result.estimatedVolume.toLocaleString()} liters`);

      updateCharts(result);
    }

    function updateCharts(result){
      const ctx1=document.getElementById("lineChart"), ctx2=document.getElementById("barChart");
      if(lineChart) lineChart.destroy(); if(barChart) barChart.destroy();

      // Enhanced Line Chart: Price Build-Up Progression
      lineChart = new Chart(ctx1, {
        type: "line",
        data: {
          labels: ["Wholesale", "Base Retail", "After Discount", "Plus Transport", "Final Price"],
          datasets: [{
            label: "Price Build-Up (R/L)",
            data: [
              result.wholesalePricePerLiter,
              result.baseRetailPricePerLiter,
              result.priceAfterDiscountPerLiter,
              result.priceAfterTransportPerLiter,
              result.finalRetailPricePerLiter
            ],
            borderColor: "#2d9d78",
            backgroundColor: "rgba(45,157,120,0.1)",
            fill: true,
            tension: 0.4,
            pointBackgroundColor: "#2d9d78",
            pointBorderColor: "#ffffff",
            pointBorderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Price Build-Up Progression - ${country.value.charAt(0).toUpperCase() + country.value.slice(1).replace('-', ' ')} (${grid.value.charAt(0).toUpperCase() + grid.value.slice(1)})`,
              color: "#2a4d7a",
              font: { size: 14, weight: 'bold', family: 'Segoe UI' }
            },
            legend: { 
              labels: { color: "#e0e0e0", font: { family: 'Segoe UI', size: 12 } }
            },
            tooltip: {
              backgroundColor: 'rgba(18, 24, 39, 0.9)',
              titleColor: '#e0e0e0',
              bodyColor: '#e0e0e0',
              borderColor: '#2a4d7a',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  const prevValue = context.dataIndex > 0 ? context.dataset.data[context.dataIndex - 1] : 0;
                  const change = context.dataIndex > 0 ? (value - prevValue).toFixed(2) : value.toFixed(2);
                  return `${context.label}: R${value.toFixed(2)} ${context.dataIndex > 0 ? `(+R${change})` : ''}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: { 
                color: "#a0aec0",
                font: { family: 'Segoe UI' },
                callback: function(value) {
                  return 'R' + value.toFixed(2);
                }
              },
              grid: { color: "rgba(255,255,255,0.1)" }
            },
            x: {
              ticks: { color: "#a0aec0", font: { family: 'Segoe UI' } },
              grid: { color: "rgba(255,255,255,0.1)" }
            }
          }
        }
      });

      // Enhanced Bar Chart: Cost Component Analysis
      barChart = new Chart(ctx2, {
        type: "bar",
        data: {
          labels: ["Retail Margin", "Tier Discount", "Transport", "Currency Risk", "Political Risk"],
          datasets: [{
            label: "Cost Components (R/L)",
            data: [
              result.retailMarginPerLiter,
              -result.tierDiscountPerLiter,
              result.transportCostPerLiter,
              result.currencyRiskPerLiter,
              result.politicalRiskPerLiter
            ],
            backgroundColor: [
              "#2d9d78", // Green for positive margin
              "#dc3545", // Red for discount (negative)
              "#1a3a5f", // Blue for transport
              "#ffc107", // Yellow for currency risk
              "#fd7e14"  // Orange for political risk
            ],
            borderColor: "rgba(255,255,255,0.2)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Cost Component Analysis - Tier ${tier.value} Customer`,
              color: "#2a4d7a",
              font: { size: 14, weight: 'bold', family: 'Segoe UI' }
            },
            legend: { 
              labels: { color: "#e0e0e0", font: { family: 'Segoe UI', size: 12 } }
            },
            tooltip: {
              backgroundColor: 'rgba(18, 24, 39, 0.9)',
              titleColor: '#e0e0e0',
              bodyColor: '#e0e0e0',
              borderColor: '#2a4d7a',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  const absValue = Math.abs(value);
                  const percentage = ((absValue / result.finalRetailPricePerLiter) * 100).toFixed(1);
                  const sign = value >= 0 ? '+' : '-';
                  return `${context.label}: ${sign}R${absValue.toFixed(2)} (${percentage}% of final price)`;
                }
              }
            }
          },
          scales: {
            y: {
              ticks: { 
                color: "#a0aec0",
                font: { family: 'Segoe UI' },
                callback: function(value) {
                  return (value >= 0 ? '+' : '') + 'R' + value.toFixed(2);
                }
              },
              grid: { 
                color: "rgba(255,255,255,0.1)",
                zeroLineColor: "rgba(255,255,255,0.3)"
              }
            },
            x: {
              ticks: { 
                color: "#a0aec0",
                font: { family: 'Segoe UI' },
                maxRotation: 45
              },
              grid: { color: "rgba(255,255,255,0.1)" }
            }
          }
        }
      });

      // Third Chart: Country Comparison Analysis
      const comparisonData = ['south-africa', 'zimbabwe', 'botswana'].map(countryCode => {
        const tierLevel = parseInt(tier.value);
        const gridLocation = grid.value;
        return calculateFuelPrice(tierLevel, countryCode, gridLocation);
      });

      const ctx3 = document.getElementById("comparisonChart");
      if(window.comparisonChart) window.comparisonChart.destroy();
      
      window.comparisonChart = new Chart(ctx3, {
        type: "doughnut",
        data: {
          labels: ['South Africa', 'Zimbabwe', 'Botswana'],
          datasets: [{
            label: 'Final Price (R/L)',
            data: comparisonData.map(result => result.finalRetailPricePerLiter),
            backgroundColor: [
              'rgba(26, 58, 95, 0.8)',   // Blue for SA
              'rgba(45, 157, 120, 0.8)', // Green for Zimbabwe  
              'rgba(42, 77, 122, 0.8)'   // Lighter blue for Botswana
            ],
            borderColor: [
              'rgba(26, 58, 95, 1)',
              'rgba(45, 157, 120, 1)',
              'rgba(42, 77, 122, 1)'
            ],
            borderWidth: 2,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Regional Price Comparison - Tier ${tier.value} (${grid.value.charAt(0).toUpperCase() + grid.value.slice(1)})`,
              color: "#2a4d7a",
              font: { size: 16, weight: 'bold', family: 'Segoe UI' }
            },
            legend: {
              position: 'right',
              labels: { 
                color: "#e0e0e0", 
                font: { family: 'Segoe UI', size: 12 },
                generateLabels: function(chart) {
                  const data = chart.data;
                  return data.labels.map((label, i) => ({
                    text: `${label}: R${data.datasets[0].data[i].toFixed(2)}`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    strokeStyle: data.datasets[0].borderColor[i],
                    lineWidth: data.datasets[0].borderWidth,
                    index: i
                  }));
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(18, 24, 39, 0.9)',
              titleColor: '#e0e0e0',
              bodyColor: '#e0e0e0',
              borderColor: '#2a4d7a',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${context.label}: R${value.toFixed(2)} (${percentage}% of total)`;
                }
              }
            }
          }
        }
      });
    }

    // Toggle parameters section visibility
    function toggleParameters() {
      const content = document.getElementById('parametersContent');
      const toggle = document.getElementById('paramToggle');
      const summary = document.getElementById('parametersSummary');
      const description = document.getElementById('parametersDescription');
      
      if (content.style.display === 'none') {
        // Show expanded view
        content.style.display = 'grid';
        summary.style.display = 'none';
        description.style.display = 'block';
        toggle.style.transform = 'rotate(0deg)';
        toggle.classList.remove('fa-chevron-right');
        toggle.classList.add('fa-chevron-down');
      } else {
        // Show collapsed view
        content.style.display = 'none';
        summary.style.display = 'block';
        description.style.display = 'none';
        toggle.style.transform = 'rotate(-90deg)';
        toggle.classList.remove('fa-chevron-down');
        toggle.classList.add('fa-chevron-right');
        updateParametersSummary();
      }
    }

    // Update the summary text when collapsed
    function updateParametersSummary() {
      const currentCountry = country.value;
      const baseCost = baseCostSlider.value;
      const wholesale = wholesaleMarginSlider.value;
      const retail = retailMarginSlider.value;
      const currency = currencyRiskSlider.value;
      
      const summaryText = `Current: Base R${parseFloat(baseCost).toFixed(1)}/L • Wholesale ${parseFloat(wholesale).toFixed(1)}% • Retail ${parseFloat(retail).toFixed(1)}% • Currency Risk ${parseFloat(currency).toFixed(1)}%`;
      document.getElementById('summaryText').textContent = summaryText;
    }

    // Initialize with defaults
    // Initialize default values but don't auto-calculate
    loadCountryDefaults();
    loadLocationDefaults();
    updateTierDiscounts();
    updateParametersSummary();
    // User must click Calculate button to see prices
  </script>
</body>
</html>
